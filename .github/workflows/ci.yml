name: FEelMRI CI (MPI + Cache + PyTest)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ------------------------------------------------------------
      # Checkout the repository
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Set up Python environment (with built-in pip caching)
      # ------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"   # ðŸ§  Caches Python dependencies installed via pip

      # ------------------------------------------------------------
      # Cache build and compiled objects
      # ------------------------------------------------------------
      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.ccache
            build/
          key: build-${{ runner.os }}-${{ hashFiles('setup.cfg', 'pyproject.toml', '**/CMakeLists.txt') }}
          restore-keys: |
            build-${{ runner.os }}-

      # ------------------------------------------------------------
      # Install system dependencies (including MPI)
      # ------------------------------------------------------------
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            python3-dev \
            python3-tk \
            cmake \
            ninja-build \
            git \
            libopenmpi-dev \
            openmpi-bin \
            mpich \
            hdf5-tools \
            ccache \
            p7zip-full
          sudo apt-get clean

      # ------------------------------------------------------------
      # Install FEelMRI and Python dependencies
      # ------------------------------------------------------------
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .[dev] pytest matplotlib mpi4py

      # ------------------------------------------------------------
      # Verify MPI installation
      # ------------------------------------------------------------
      - name: Verify MPI
        run: |
          mpirun --version
          which mpirun

      # ------------------------------------------------------------
      # Run FEelMRI tests (with MPI)
      # ------------------------------------------------------------
      - name: Run tests with MPI
        env:
          MPLBACKEND: Agg
          FEELMRI_FAST_TEST: "1"
        run: |
          echo "Unzipping phantom files..."
          7z x examples/phantoms/phantoms_compressed.zip -o examples/phantoms/

          echo "Running import tests..."
          pytest -v --maxfail=1 --disable-warnings

      # ------------------------------------------------------------
      # Upload logs on failure (for debugging)
      # ------------------------------------------------------------
      - name: Upload pytest logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-logs
          path: .pytest_cache
